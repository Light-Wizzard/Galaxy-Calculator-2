# Galaxy Calculator 2 appveyor configuration files
# https://ci.appveyor.com/tools/validate-yaml
version: '{branch}-{build}'

branches:
  only:
    - master

configuration: Release

platform:
  - x86

image:
  - Ubuntu2004
  - Visual Studio 2019

stack: python 3.8

for:
-
  matrix:
    only:
      - image: Ubuntu2004
  environment:
    RUNTIME_LINKAGE: static
    COVERITY_BUILD_CANDIDATE: True
    #https://www.appveyor.com/docs/build-environment/#qt
    QT5: $HOME/Qt/5.15.2/gcc_64/bin
    QT_IF_VERSION: '3.1.1'
    PRJLIBS: VCRUNTIME140.dll MSVCP140.dll
    BIN: GalaxyCalculator2
    MY_OS: Ubuntu2004
    QIF_PACKAGE_URI: 'packages/com.lightwizzard.galaxycalculator2/data'
    PY_DIR: $HOME/venv3.8
  install:
    - sh: echo install Ubuntu
    - ps: $env:package_version = ("$(git describe --tags --always --long)").trim()
    - ps: Update-AppveyorBuild -Version "$env:package_version-$env:APPVEYOR_BUILD_NUMBER"
    - sh: sudo apt-get update -qq && sudo apt-get install -qq
    - sh: sudo apt-get -y install build-essential git cmake libpng-dev libjpeg-dev libtiff-dev libglu1-mesa-dev libxmu-dev libxi-dev
  before_build:
    - sh: echo before_build Ubuntu
    - sh: set PATH=%PY_DIR%;%PY_DIR%/Scripts;%PATH%
    - sh: echo 1 $PATH
    - sh: set PATH=%QT5%/bin;%PATH%
    - sh: echo 2 $PATH
    - sh: echo qtenv2.bat
    #- sh: $HOME/Qt/5.15.2/gcc_64/bin/bin/qtenv2.bat
    - sh: '%QT5%/bin/qtenv2.bat'
  build_script:
    - sh: echo build_script Ubuntu
    - sh: cd %APPVEYOR_BUILD_FOLDER%
    - sh: mkdir build
    - sh: cd build
    - sh: qmake -v && qmake ../%BIN%.pro CONFIG+=release DESTDIR=%cd% && make
  after_build:
    - sh: echo after_build Ubuntu
    # Add a link to the build output within the source directory. This is needed because AppVeyor does
    # not support extracting artifacts from out-of-source build directories. See 'artifacts' below.
    - sh: ls
    - sh: mkdir deploy
    - sh: cp "%APPVEYOR_BUILD_FOLDER%/build/%BIN%" "deploy/%BIN%"
    - sh: linuxdeployqt "deploy/%BIN%" --verbose=2
    - sh: 7z a -tzip "%BIN%-%MY_OS%.zip" deploy -r
    - sh: cp "%APPVEYOR_BUILD_FOLDER%/build/%BIN%-%MY_OS%.zip" "%APPVEYOR_BUILD_FOLDER%/%BIN%-%MY_OS%.zip"
    - sh: echo APPVEYOR_BUILD_FOLDER=%APPVEYOR_BUILD_FOLDER%
    - sh: cp *.zip %APPVEYOR_BUILD_FOLDER%
    - sh: cp *.exe %APPVEYOR_BUILD_FOLDER%
    - sh: cd %APPVEYOR_BUILD_FOLDER%
    - sh: echo Current Path is %cd%
    - sh: ls
    - sh: echo Completed-Build Ubuntu
  artifacts:
    - path: '%BIN%*.zip'
      name: 'ZipInstaller'
    - path: '%BIN%*'
      name: 'ExecutableFile'
-
  matrix:
    only:
      - image: Visual Studio 2019
  environment:
    RUNTIME_LINKAGE: static
    COVERITY_BUILD_CANDIDATE: True
    QT_VERSION: 5.15
    QT5: C:\Qt\5.15.2\mingw81_32
    MINGW: C:\Qt\Tools\mingw810_32
    QT_IF_VERSION: '3.1.1'
    PRJLIBS: VCRUNTIME140.dll MSVCP140.dll
    BIN: GalaxyCalculator2
    MY_OS: Windows
    QIF_PACKAGE_URI: 'packages\com.lightwizzard.galaxycalculator2\data'
    PY_DIR: C:\Python38
  install:
    - ps: write-host "install Windows"
    # Create our AppVeyor version
    - ps: $env:commit = $env:appveyor_repo_commit.SubString(0,7)
    - ps: Update-AppveyorBuild -Version ("{0}-{1}-{2}" -f $env:appveyor_repo_branch,$env:appveyor_build_number,$env:commit )
  before_build:
    - ps: write-host "before_build Windows"
    - cmd: set PATH=%PY_DIR%;%PY_DIR%\Scripts;%PATH%
    - cmd: set PATH=%MINGW%\bin;%QT5%\bin;%PATH%
    - call "%QT5%\bin\qtenv2.bat"
    - call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars32.bat"
  build_script:
    - ps: write-host "build_script Windows"
    - cd %APPVEYOR_BUILD_FOLDER%
    - mkdir build
    - cd build
    - qmake -v && qmake ..\%BIN%.pro CONFIG+=release CONFIG+=c++11 DESTDIR=%cd% && mingw32-make
  after_build:
    - ps: write-host "after_build Windows"
    - dir
    - mkdir deploy
    - copy "%APPVEYOR_BUILD_FOLDER%\build\%BIN%.exe" "deploy\%BIN%.exe"
    - windeployqt "deploy/%BIN%.exe" --verbose=2
    #- for %%I in (%PRJLIBS%) do copy %PRJLIBDIR%\%%I deploy\
    - 7z a -tzip "%BIN%-%MY_OS%.zip" deploy -r
    - copy "%APPVEYOR_BUILD_FOLDER%\build\%BIN%-%MY_OS%.zip" "%APPVEYOR_BUILD_FOLDER%\%BIN%-%MY_OS%.zip"
    - echo APPVEYOR_BUILD_FOLDER=%APPVEYOR_BUILD_FOLDER%
    #- xcopy /s /e /f "%APPVEYOR_BUILD_FOLDER%\build\deploy" "%APPVEYOR_BUILD_FOLDER%\%QIF_PACKAGE_URI%"
    #- C:\Qt\QtIFW-3.1.1\bin\binarycreator.exe --offline-only -c "%APPVEYOR_BUILD_FOLDER%\config\config.xml" -p "%APPVEYOR_BUILD_FOLDER%\packages" "%BIN%-Windows-Installer.exe"
    #- 7z a -tzip "%BIN%-Windows-Installer.zip" "%BIN%-Windows-Installer.exe"
    - copy *.zip %APPVEYOR_BUILD_FOLDER%
    - copy *.exe %APPVEYOR_BUILD_FOLDER%
    - cd %APPVEYOR_BUILD_FOLDER%
    - echo Current Path is %cd%
    - dir
    - ps: write-host "Completed-Build Windows"
  artifacts:
    - path: '%BIN%*.zip'
      name: 'ZipInstaller'
    - path: '%BIN%*.exe'
      name: 'ExecutableFile'

deploy:
  - provider: GitHub
    release: continuous
    artifact: 'ZipInstaller'
    draft: false
    prerelease: true
    auth_token:
      secure: 5Kb03ANp7s6KeJKren+ROsEnuCk2tXGby36aqYpG0WV8xfHBg26Td9B4C9jpI/O/
  - provider: GitHub
    release: continuous
    artifact: 'ExecutableFile'
    draft: false
    prerelease: true
    auth_token:
      secure: 5Kb03ANp7s6KeJKren+ROsEnuCk2tXGby36aqYpG0WV8xfHBg26Td9B4C9jpI/O/
############################################## End of File ####################

